# データ分析プログラム README

このプログラムは、dataフォルダ内の複数のExcelファイルを読み込み、これらのデータに対してカイ二乗検定を行います。
さらに、指定された試行回数分、各ファイルのシートをランダムに振り分けた場合のカイ二乗値を求め、これらを比較することで統計的有意性を評価します。

以下の「データの準備」と「プログラムの実行方法」のみ読めば、本プログラムを利用できます。
それ以外の詳細については、適宜参照してください。
何か不明点があれば、ページ下部に記載の連絡先までお気軽にご連絡ください。


## データの準備

1. 分析対象のExcelファイル(`.xlsx` or `.xls`)を`data`フォルダに配置します。
2. Excelファイルは**1つ以上**配置可能です。ファイル名は任意です。
3. 各Excelファイル内には、以下の条件を満たすデータが含まれている必要があります。
   - 各データがシートごとに分割されていること
   - データは**数値のみ**で構成されていること
   - 比較対象のデータ同士で、**行列の形状(データサイズ)が等しい**こと
   - **シートの1行目と1列目は削除**されます（ヘッダー行・列として使用されないため）
   - シート内の**空欄のセルは0**として扱われます
   - 全てのセルが空欄のシートは分析対象から外れます

`archive`フォルダには、本プログラムの動作確認のために利用したdemoファイルが含まれています。
データ整形の参考にしてください。

- HU_data : 安達先生から頂いたデータ。(詳細は安達先生にお聞きください。)
- Otani_data : 安達先生から頂いたデータ。(詳細は安達先生にお聞きください。)
- demo_data : データを極端に偏らせた場合、正確に有意差を捉えられているかを確認。また、ファイルが3つ以上の場合の動作を確認。
- demo_row1 : 行数が1の場合の動作確認。行数が1の場合、各セルの期待度数は観測度数と等しいため、カイ二乗値の計算式からカイ二乗値は必然的に0になる。



## プログラムの実行方法

プログラムの実行方法は非常にシンプルです。
プログラムが配置されているフォルダに移動し、仮想環境を有効化します。(仮想環境については、下記の「作業内容の記録」にて簡単に説明しますが、理解しなくても構いません。)
その後、プログラム実行のコマンドを入力します。

### コマンドラインからの実行

1. ターミナルまたはコマンドプロンプトを開き、プログラムが配置されているフォルダに移動します。

   ```bash
   cd プロジェクトフォルダ
   ```

2. 仮想環境を有効化します。以下のコマンドを入力して下さい。

    ```bash
    # 仮想環境の有効化（Unix/Linux/macOSの場合）
    source venv/bin/activate

    # 仮想環境の有効化（Windowsの場合）
    venv\Scripts\activate
    ```

3. プログラムを実行します。

   ```bash
   python analyze_data.py
   ```

   ※ プログラムを一時中断したいときは、ctrl + c で中断できます。

### プログラムの流れ
作成したプログラム("analyza_data.py")について、簡単に解説します。
プログラム内容を理解したいときに参照してください。

1. プログラムを起動すると、`data`フォルダ内のExcelファイルが読み込まれます。
2. 各Excelファイルの有効なシートデータが取得されます。(全てのセルが空欄のシートなどはスキップされます。)
3. 各Excelファイルごとにクロス集計表の作成を行い、`output`フォルダに保存します。(ファイル名 : crosstab)
4. クロス集計表から各セルの期待度数を求め、`output`フォルダに保存します。(ファイル名 : expected)
5. 元のデータとその期待度数から、**まずは行ごとに**カイ二乗値を求め、各行のカイ二乗値を全て合計することでそのExcelファイル全体のカイ二乗値とします。
6. さらに、各Excelファイルごとのカイ二乗値を合計することで、実験データ全体のカイ二乗値とします。

7. 統計的優位性評価のため、全てのExcelファイルのシートを混ぜ、ランダムに振り分けます。(各Excelファイルの元のシート数に基づいて振り分けられます。)
8. ランダムに振り分けたExcelファイルに対して、上記2~6を行います。
9. 元のデータ全体のカイ二乗値と、ランダムに振り分けたデータ全体のカイ二乗値を比較し、前者が大きい回数を数えます。
10. 入力された試行回数分、上記7~9を行い、最終的に元のデータ全体のカイ二乗値が大きかった回数とその割合を出力します。

### 試行回数の入力

- プログラム実行中に、ランダム化検定の試行回数を入力するプロンプトが表示されます。
- **正の整数値**を入力してください。
- 試行回数が大きいほど結果の精度は上がりますが、処理時間も長くなります。

## 出力結果

- `output`フォルダ内に、各ファイルの**クロス集計表**と**期待度数**がExcel形式で保存されます。
- プログラムの実行結果として、ターミナルに以下の情報が表示されます。
  - **処理時間**
  - **試行回数**
  - **元のカイ二乗値**
  - **元のカイ二乗値の方が大きい回数**
  - **元のカイ二乗値の方が大きい割合**

  出力の解釈としては、元のカイ二乗値がランダムな場合より大きいということは、元のファイル間に何かしらの差異・傾向があることを示唆していると言えるでしょう。

### "より大きい"ではなく、"以上"の割合を求めたい場合は、プログラム後半の以下の部分をコメントに従って変更してください。

   ```
   ##### オリジナルのカイ二乗値が大きい場合にカウントする #####
   ##### もし、オリジナルのカイ二乗値"以上"をカウントしたい場合は、">"を">="に変更する #####
   if original_chi_square > random_chi_square:
      count_greater_equal += 1
   ```

## エラー処理

- プログラムは、以下のエラーに対して適切なメッセージを表示します。
  - `data`フォルダが存在しない場合
  - Excelファイルが見つからない場合
  - データが不適切な場合（空のシート、数値以外のデータなど）
  - シート間でデータサイズが一致しない場合


## 連絡先

ご質問や不明点がある場合は、開発者までお気軽にお問い合わせください。

- **開発者**: 進藤 稜真
- **作成日**: 2024年11月11日
- **Eメール**: shinto.ryoma@gmail.com


## 作業内容の記録

プログラムの実行とは関係ありませんが、念のため、環境構築時に本PCで行った内容を以下に記録します。

## 環境設定

### 1. Pythonのインストール

Python 3.10.11 をインストールしました。

- [Python公式サイト](https://www.python.org/downloads/)

### 2. 仮想環境の作成

仮想環境を作成しました。
仮想環境を使用すると、プロジェクトごとにパッケージの依存関係を管理できます。
すなわち、本PCで他のプログラムを実行するためにパッケージのバージョンを変更しても、この仮想環境内のバージョンは固定されたままになります。
よって、仮想環境を有効化してプログラムを実行することで、パッケージのバージョンの不整合による不具合を防ぐことができます。

```bash
# 仮想環境の作成
python -m venv venv

# 仮想環境の有効化（Unix/Linux/macOSの場合）
source venv/bin/activate

# 仮想環境の有効化（Windowsの場合）
venv\Scripts\activate
```

### 3. 必要なパッケージのインストール

以下のコマンドを使用して、プログラムの実行に必要なパッケージをインストールしました。

```bash
pip install pandas numpy openpyxl
```

## プログラムの配置

1. プログラムファイル（例: `analyze_data.py`）を以下のフォルダに配置しました。
2. このフォルダ内に`data`フォルダと`output`フォルダを作成しました。

```
プロジェクトフォルダ/
├── analyze_data.py
├── data/
└── output/
```
